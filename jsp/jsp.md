# JSP

## 基本概念





## jsp 本质



home.jsp

```java
<%--
    在jsp文件中，我们可以在html中嵌套java代码
--%>
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<html>
<head>
    <title>qq注册页面</title>
</head>
<body>
    <% out.print(request.getContextPath()); %>
    <%--简写方式--%>
    <%=request.getContextPath() %>

    <%--注册表单--%>
    <form action="<%out.print(request.getContextPath()); %>/MyRegister" method="post" >
        <p>用户名：<input type="text" name="username"></p>
        <p>用户密码：<input type="password" name="password"></p>
        <p>邮箱： <input type="email" name="email"></p>
        <p>爱好：
            <input type="checkbox" value="eat" name="hobbies"> 吃
            <input type="checkbox" value="drink" name="hobbies"> 喝
            <input type="checkbox" value="play" name="hobbies"> 玩
            <input type="checkbox" value="game" name="hobbies"> 打游戏
        </p>
        <p><input type="submit" value="注册"></p>
    </form>

</body>
</html>
```



home_jsp.java

```java
/*
 * Generated by the Jasper component of Apache Tomcat
 * Version: Apache Tomcat/9.0.7
 * Generated at: 2021-04-17 12:28:30 UTC
 * Note: The last modified time of this file was set to
 *       the last modified time of the source file after
 *       generation to assist with modification tracking.
 */
package org.apache.jsp;

import javax.servlet.*;
import javax.servlet.http.*;
import javax.servlet.jsp.*;

public final class home_jsp extends org.apache.jasper.runtime.HttpJspBase
    implements org.apache.jasper.runtime.JspSourceDependent,
                 org.apache.jasper.runtime.JspSourceImports {

  private static final javax.servlet.jsp.JspFactory _jspxFactory =
          javax.servlet.jsp.JspFactory.getDefaultFactory();

  private static java.util.Map<java.lang.String,java.lang.Long> _jspx_dependants;

  private static final java.util.Set<java.lang.String> _jspx_imports_packages;

  private static final java.util.Set<java.lang.String> _jspx_imports_classes;

  static {
    _jspx_imports_packages = new java.util.HashSet<>();
    _jspx_imports_packages.add("javax.servlet");
    _jspx_imports_packages.add("javax.servlet.http");
    _jspx_imports_packages.add("javax.servlet.jsp");
    _jspx_imports_classes = null;
  }

  private volatile javax.el.ExpressionFactory _el_expressionfactory;
  private volatile org.apache.tomcat.InstanceManager _jsp_instancemanager;

  public java.util.Map<java.lang.String,java.lang.Long> getDependants() {
    return _jspx_dependants;
  }

  public java.util.Set<java.lang.String> getPackageImports() {
    return _jspx_imports_packages;
  }

  public java.util.Set<java.lang.String> getClassImports() {
    return _jspx_imports_classes;
  }

  public javax.el.ExpressionFactory _jsp_getExpressionFactory() {
    if (_el_expressionfactory == null) {
      synchronized (this) {
        if (_el_expressionfactory == null) {
          _el_expressionfactory = _jspxFactory.getJspApplicationContext(getServletConfig().getServletContext()).getExpressionFactory();
        }
      }
    }
    return _el_expressionfactory;
  }

  public org.apache.tomcat.InstanceManager _jsp_getInstanceManager() {
    if (_jsp_instancemanager == null) {
      synchronized (this) {
        if (_jsp_instancemanager == null) {
          _jsp_instancemanager = org.apache.jasper.runtime.InstanceManagerFactory.getInstanceManager(getServletConfig());
        }
      }
    }
    return _jsp_instancemanager;
  }

  public void _jspInit() {
  }

  public void _jspDestroy() {
  }

  public void _jspService(final javax.servlet.http.HttpServletRequest request, final javax.servlet.http.HttpServletResponse response)
      throws java.io.IOException, javax.servlet.ServletException {

    if (!javax.servlet.DispatcherType.ERROR.equals(request.getDispatcherType())) {
      final java.lang.String _jspx_method = request.getMethod();
      if ("OPTIONS".equals(_jspx_method)) {
        response.setHeader("Allow","GET, HEAD, POST, OPTIONS");
        return;
      }
      if (!"GET".equals(_jspx_method) && !"POST".equals(_jspx_method) && !"HEAD".equals(_jspx_method)) {
        response.setHeader("Allow","GET, HEAD, POST, OPTIONS");
        response.sendError(HttpServletResponse.SC_METHOD_NOT_ALLOWED, "JSPs only permit GET, POST or HEAD. Jasper also permits OPTIONS");
        return;
      }
    }

    final javax.servlet.jsp.PageContext pageContext;
    javax.servlet.http.HttpSession session = null;
    final javax.servlet.ServletContext application;
    final javax.servlet.ServletConfig config;
    javax.servlet.jsp.JspWriter out = null;
    final java.lang.Object page = this;
    javax.servlet.jsp.JspWriter _jspx_out = null;
    javax.servlet.jsp.PageContext _jspx_page_context = null;


    try {
      response.setContentType("text/html;charset=UTF-8");
      pageContext = _jspxFactory.getPageContext(this, request, response,
      			null, true, 8192, true);
      _jspx_page_context = pageContext;
      application = pageContext.getServletContext();
      config = pageContext.getServletConfig();
      session = pageContext.getSession();
      out = pageContext.getOut();
      _jspx_out = out;

      out.write("\r\n");
      out.write("\r\n");
      out.write("<html>\r\n");
      out.write("<head>\r\n");
      out.write("    <title>qq注册页面</title>\r\n");
      out.write("</head>\r\n");
      out.write("<body>\r\n");
      out.write("    ");
 out.print(request.getContextPath()); 
      out.write("\r\n");
      out.write("    ");
      out.write("\r\n");
      out.write("    ");
      out.print(request.getContextPath() );
      out.write("\r\n");
      out.write("\r\n");
      out.write("    ");
      out.write("\r\n");
      out.write("    <form action=\"");
out.print(request.getContextPath()); 
      out.write("/MyRegister\" method=\"post\" >\r\n");
      out.write("        <p>用户名：<input type=\"text\" name=\"username\"></p>\r\n");
      out.write("        <p>用户密码：<input type=\"password\" name=\"password\"></p>\r\n");
      out.write("        <p>邮箱： <input type=\"email\" name=\"email\"></p>\r\n");
      out.write("        <p>爱好：\r\n");
      out.write("            <input type=\"checkbox\" value=\"eat\" name=\"hobbies\"> 吃\r\n");
      out.write("            <input type=\"checkbox\" value=\"drink\" name=\"hobbies\"> 喝\r\n");
      out.write("            <input type=\"checkbox\" value=\"play\" name=\"hobbies\"> 玩\r\n");
      out.write("            <input type=\"checkbox\" value=\"game\" name=\"hobbies\"> 打游戏\r\n");
      out.write("        </p>\r\n");
      out.write("        <p><input type=\"submit\" value=\"注册\"></p>\r\n");
      out.write("    </form>\r\n");
      out.write("\r\n");
      out.write("</body>\r\n");
      out.write("</html>\r\n");
    } catch (java.lang.Throwable t) {
      if (!(t instanceof javax.servlet.jsp.SkipPageException)){
        out = _jspx_out;
        if (out != null && out.getBufferSize() != 0)
          try {
            if (response.isCommitted()) {
              out.flush();
            } else {
              out.clearBuffer();
            }
          } catch (java.io.IOException e) {}
        if (_jspx_page_context != null) _jspx_page_context.handlePageException(t);
        else throw new ServletException(t);
      }
    } finally {
      _jspxFactory.releasePageContext(_jspx_page_context);
    }
  }
}

```



**分析**

1-   jsp文件被tomcat转换成java文件

2-   该java文件继承了HttpJspBase，查看HttpJspBase源码可以得到HttpJspBase继承自HttpServlet

```java
public final class home_jsp extends org.apache.jasper.runtime.HttpJspBase
    implements org.apache.jasper.runtime.JspSourceDependent,
                 org.apache.jasper.runtime.JspSourceImports 
```

3-  jsp文件本质就是servlet文件

4-  同样，存在生命周期

```java
public void _jspInit() {
  }

  public void _jspDestroy() {
  }

  public void _jspService(final javax.servlet.http.HttpServletRequest request, final javax.servlet.http.HttpServletResponse response)
      throws java.io.IOException, javax.servlet.ServletException {}


```

5-   _jspService 中方法体代码

```java
public void _jspService(final javax.servlet.http.HttpServletRequest request, final javax.servlet.http.HttpServletResponse response)
      throws java.io.IOException, javax.servlet.ServletException {
    
    final javax.servlet.jsp.PageContext pageContext;//页面上下文，可以返回servletContext
    javax.servlet.http.HttpSession session = null;//session
    final javax.servlet.ServletContext application;//ServletContext，代表整个web 应用
    final javax.servlet.ServletConfig config;//ServletConfig 配置对象
    javax.servlet.jsp.JspWriter out = null;//功能等同PrintWriter out = response.getWriter();
    final java.lang.Object page = this;// 当前页面
    javax.servlet.jsp.JspWriter _jspx_out = null;
    javax.servlet.jsp.PageContext _jspx_page_context = null;


    try {
      response.setContentType("text/html;charset=UTF-8");
      pageContext = _jspxFactory.getPageContext(this, request, response,
      			null, true, 8192, true);
      _jspx_page_context = pageContext;
      application = pageContext.getServletContext();  // 返回servletContext
      config = pageContext.getServletConfig();    // 返回 ServletConfig
      session = pageContext.getSession();
      out = pageContext.getOut();
      _jspx_out = out;

      out.write("\r\n");
      out.write("\r\n");
      out.write("<html>\r\n");
      out.write("<head>\r\n");
      out.write("    <title>qq注册页面</title>\r\n");
        。。。。。
    
    
}
```



## jsp 语法

### jsp表达式

```java
  <%--<%= 变量或者表达式%>--%>
  <%=new SimpleDateFormat("hh:mm:ss").format(new Date(System.currentTimeMillis())) %>
      
```



### jsp声明

(全局变量和全局函数),默认生成在_jspService()中

```java
  <%!
  static {
    System.out.println("该类已被访问");
  }
  private int globalVar = 0;
  public int getGlobalVar(){
      return globalVar;
  }
  %>
```



### 脚本片段

```java
<%for (int i = 0; i < 5; i++) {
out.println(getGlobalVar());
%>
<h1>hello world <%= i%></h1>
<% } %>

```



### JSP指令

```jsp
<%@page args.... %>
<%@include file=""%>

<%--@include会将两个页面合二为一--%>
<%@include file="common/header.jsp"%>
<h1>网页主体</h1>

<%@include file="common/footer.jsp"%>

<hr>


<%--jSP标签
    jsp:include：拼接页面，本质还是三个java文件
    --%>
<jsp:include page="/common/header.jsp"/>
<h1>网页主体</h1>
<jsp:include page="/common/footer.jsp"/>
```



## 9大内置对象

```
PageContext 
Request 
Response
Session 
Application 
config 
out
page 
exception
```



## 4大作用域

> 存数据

```java
public static final int PAGE_SCOPE = 1;
public static final int REQUEST_SCOPE = 2;
public static final int SESSION_SCOPE = 3;
public static final int APPLICATION_SCOPE = 4;
<%--存数据--%>
<%
    pageContext.setAttribute("pageContextName","pageContext");//保存的数据在当前页面有效
    request.setAttribute("requestName","request");//保存的数据在一次请求中有效,请求转发也会携带这个数据
    session.setAttribute("sessionName","session");//保存的数据在一次会话中有效,从打开浏览器到关闭浏览器
    application.setAttribute("applicationName","application");//保存的数据在服务器中有效
4
    
    \
    
    \]
    
    
    
    ，从打开服务器到关闭服务器
%>
```

源码中存数据做的事情

```java
public void setAttribute (String name,Object attribute,int scope){
    switch (scope) {
    case PAGE_SCOPE:
      mPage.put (name, attribute);
      break;
    case REQUEST_SCOPE:
      mRequest.put (name, attribute);
      break;
    case SESSION_SCOPE:
      mSession.put (name, attribute);
      break;
    case APPLICATION_SCOPE:
      mApp.put (name, attribute);
      break;
    default:
      throw new IllegalArgumentException  ("Bad scope " + scope);
    }
}
```

> 取数据，从作用域最小的开始找，如果存的时候有Key是同名的，数据将会取不出来

```java
<%
    String pageContextName = (String) pageContext.findAttribute("pageContextName");
    String requestName = (String) request.getAttribute("requestName");
    String sessionName = (String) session.getAttribute("sessionName");
    String applicationName = (String) application.getAttribute("applicationName");
%>
```

源码如下

```java
//从作用域最小的开始找
public Object findAttribute (String name){
    if (mPage.containsKey (name)) {
      return mPage.get (name);
    }
    else if (mRequest.containsKey (name)) {
      return mRequest.get (name);
    }
    else if (mSession.containsKey (name)) {
      return mSession.get (name);
    }
    else if (mApp.containsKey (name)) {
      return mApp.get (name);
    }
    else {
      return null;
    }
}
```



##  JSTL标签、EL表达式

> 第一步就是添加依赖

```xml
<!-- https://mvnrepository.com/artifact/javax.servlet/jstl -->
<dependency>
    <groupId>javax.servlet</groupId>
    <artifactId>jstl</artifactId>
    <version>1.2</version>
</dependency>
<!-- https://mvnrepository.com/artifact/taglibs/standard -->
<dependency>
    <groupId>taglibs</groupId>
    <artifactId>standard</artifactId>
    <version>1.1.2</version>
</dependency>
```

> EL表达式：${}

- **获取数据**
- **执行运算**
- **获取web开发的常用对象**

![image-20200803111642332](https://i.loli.net/2020/08/03/4AFQB6f9bIVwYyx.png)

> 测试代码

```jsp
<%--
跳转到coreif.isp页面参数为：username=param.username
完整路径为http://localhost:8080/jsp/coreif.jsp?username=admin
--%>
<form action="coreif.jsp" method="get">
    <%--
    EL表达式获取表单中的数据
    ${param.参数名}
    --%>
    <input type="text" name="username" value="${param.username}">
    <input type="submit" value="登录">
</form>

<%--判断如果提交的用户名是管理员，则登录成功--%>
<c:if test="${param.username=='admin'}" var="isAdmin">
    <c:out value="管理员欢迎您！"/>
</c:if>

<%--自闭合标签--%>
<c:out value="${isAdmin}"/>
```





## **用户注册案例**

引入依赖坐标

```xml
    <!--jsp-->
    <dependency>
      <groupId>javax.servlet</groupId>
      <artifactId>jsp-api</artifactId>
      <version>2.0</version>
    </dependency>
```



编写注册表单

```jsp
<%--
    在jsp文件中，我们可以在html中嵌套java代码
--%>
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<html>
<head>
    <title>qq注册页面</title>
</head>
<body>
    <% out.print(request.getContextPath()); %>
    <%--简写方式--%>
    <%=request.getContextPath() %>

    <%--注册表单--%>
    <form action="<%out.print(request.getContextPath()); %>/MyRegister" method="post" >
        <p>用户名：<input type="text" name="username"></p>
        <p>用户密码：<input type="password" name="password"></p>
        <p>邮箱： <input type="email" name="email"></p>
        <p>爱好：
            <input type="checkbox" value="eat" name="hobbies"> 吃
            <input type="checkbox" value="drink" name="hobbies"> 喝
            <input type="checkbox" value="play" name="hobbies"> 玩
            <input type="checkbox" value="game" name="hobbies"> 打游戏
        </p>
        <p><input type="submit" value="注册"></p>
    </form>

</body>
</html>

```



处理表单的请求参数

```xml 
    <servlet>
      <servlet-name>MyRegister</servlet-name>
      <servlet-class>com.wukong.servlet.MyRegister</servlet-class>
    </servlet>
    <servlet-mapping>
      <servlet-name>MyRegister</servlet-name>
      <url-pattern>/MyRegister</url-pattern>
    </servlet-mapping>

```



```
package com.wukong.servlet;
/* author: 悟空非空也（B站/知乎/公众号） */


import com.wukong.util.JdbcUtil;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.io.PrintWriter;

public class MyRegister  extends HttpServlet {

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        super.doGet(req, resp);
    }

    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
         // 对于post 请求，request对象接收到请求参数前,进行utf-8编码设置
        request.setCharacterEncoding("utf-8");
         // response 响应信息给浏览器之前，进行Utf-8 编码设置 和 响应内容类型设置
        // 简写   response.setContentType("text/html;charset=utf-8");
        response.setCharacterEncoding("utf-8");
        response.setContentType("text/html");

        PrintWriter out = response.getWriter();

        //接收用户名参数
        String username = request.getParameter("username");

        // 在页面上输出
        out.println("用户名为："+ username);
        // 在控制台输出
        System.out.println("用户名为："+ username );
        // 作业： 存入到数据库中
        // ？？？？？？
        JdbcUtil jdbcUtil = new JdbcUtil();
        /**
         * 1 连接数据库
         * 2  向数据库中插入请求参数
         *
         */

        // 接收密码参数
        String password = request.getParameter("password");
        out.println("密码为:" + password);
        System.out.println("密码为:" + password);

        // 接收邮箱参数
        String email = request.getParameter("email");
        out.println("邮箱为：" + email );
        System.out.println("邮箱为：" + email );

        // 接收爱好参数
        String[] hobbiesArray = request.getParameterValues("hobbies");
        for (String hobby: hobbiesArray) {
            out.println("爱好为：" +hobby);
            System.out.println("爱好为：" +hobby);
        }
    }
}

```



## post 中文乱码

```
 // 对于post 请求，request对象接收到请求参数前,进行utf-8编码设置
        request.setCharacterEncoding("utf-8");
         // response 响应信息给浏览器之前，进行Utf-8 编码设置 和 响应内容类型设置
        // 简写   response.setContentType("text/html;charset=utf-8");
        response.setCharacterEncoding("utf-8");
        response.setContentType("text/html");
```



## get 中文乱码

```


```



